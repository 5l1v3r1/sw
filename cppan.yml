local_settings:
    use_shared_libs: false
    rc_enabled: false
    #storage_dir: .s
    #build_dir_type: local
    #use_cache: true
    builds:
        vs_release:
            generator: Visual Studio 15 2017 #Win64

        vs_preview:
            c_compiler: c:/Program Files (x86)/Microsoft Visual Studio/Preview/Community/VC/Tools/MSVC/14.12.25805/bin/Hostx64/x64/cl.exe
            cxx_compiler: c:/Program Files (x86)/Microsoft Visual Studio/Preview/Community/VC/Tools/MSVC/14.12.25805/bin/Hostx64/x64/cl.exe

        vs_llvm:
            generator: Visual Studio 15 2017 Win64
            toolset: LLVM-vs2014
            configuration: Debug

        # run vcvars64 before this config
        win_clang_ninja_dbg:
            generator: Ninja
            c_compiler: clang-cl
            cxx_compiler: clang-cl
            configuration: Debug

        # run vcvars64 before this config
        win_clang_ninja_rwdi:
            generator: Ninja
            c_compiler: clang-cl
            cxx_compiler: clang-cl
            configuration: RelWithDebInfo

        # run vcvars64 before this config
        win_clang_ninja_rel:
            generator: Ninja
            c_compiler: clang-cl
            cxx_compiler: clang-cl
            configuration: Release

        gcc8:
            generator: Ninja
            c_compiler: gcc-8
            cxx_compiler: g++-8
            c_flags: -w
            cxx_flags: -w

        gcc8_debug:
            generator: Ninja
            c_compiler: gcc-8
            cxx_compiler: g++-8
            c_flags: -w
            cxx_flags: -w
            configuration: Debug
            use_cache: false
            build_dir: build_ninja_gcc_debug

        clang6_debug:
            generator: Ninja
            c_compiler: clang-6.0
            cxx_compiler: clang++-6.0
            configuration: Debug
            use_cache: false
            build_dir: build_ninja_clang_debug

common_settings:
    c++: 17
    options:
        any:
            compile_options:
                msvc:
                    public:
                        - -permissive-


projects:
    tools.client:
        root_directory: src/tools
        files: client.cpp
        condition: WIN32
        output_name: client.com
        options:
            any:
                definitions:
                    public:
                        - UNICODE
        dependencies:
            - pvt.cppan.demo.boost.dll: 1
            - pvt.cppan.demo.boost.filesystem: 1

    tools.sqlite2cpp:
        files:
            - src/tools/sqlite2cpp.cpp
        dependencies:
            - pvt.egorpugin.primitives.filesystem: master
            - pvt.egorpugin.primitives.context: master
            - pvt.cppan.demo.sqlite3: 3

    client:
        root_directory: src/client
        executable_type: win32
        files: .*
        #api_name:
        #    - CPPAN_BUILDER_API
        #    - CPPAN_MANAGER_API
        dependencies:
            - builder
            - driver.cpp
            - pvt.cppan.demo.taywee.args: "*"
            - pvt.egorpugin.primitives.minidump: master
            - pvt.cppan.demo.giovannidicanio.winreg: master

        post_sources: |
            file(GLOB_RECURSE x "${SDIR}/*")
            source_group(TREE ${SDIR} PREFIX "Source Files" FILES ${x})

    driver.cpp:
        type: library
        #static_only: true
        api_name: SW_DRIVER_CPP_API
        export_if_static: true

        files:
            - include/sw/driver/cpp/.*
            - src/driver/cpp/.*
        exclude_from_build:
            - src/driver/cpp/misc/.*

        include_directories:
            - include
            - src/driver/cpp # make private

        options:
            any:
                compile_options:
                    msvc:
                        public:
                            - /wd4244 # conversion from to, possible loss of data
                            - /bigobj

        dependencies:
            public:
                - builder
                - pvt.cppan.demo.boost.assign: 1
            private:
                - pvt.egorpugin.primitives.context: master
                - pvt.cppan.demo.boost.uuid: 1
                - name: pvt.egorpugin.primitives.embedder
                  version: master
                  ref: embedder
                - name: pvt.cppan.demo.lexxmark.winflexbison.flex
                  version: master
                  ref: flex
                  condition:
                      - WIN32
                - name: pvt.cppan.demo.lexxmark.winflexbison.bison
                  version: master
                  ref: bison
                  condition:
                      - WIN32

        post_sources: |
            if (WIN32)
                add_src_dir(src/driver/cpp/misc/*)
            endif()

            file(GLOB_RECURSE x "${SDIR}/*")
            source_group(TREE ${SDIR} PREFIX "Source Files" FILES ${x})

            set(gen_src
                ${SDIR}/src/driver/cpp/inserts/inserts.cpp.in
                ${SDIR}/src/driver/cpp/inserts/cppan.cpp
            )

            add_custom_command(OUTPUT ${BDIR}/inserts.driver.cpp.cpp
                COMMAND ${embedder} ${SDIR}/src/driver/cpp/inserts/inserts.cpp.in ${BDIR}/inserts.driver.cpp.cpp
                DEPENDS ${embedder} ${gen_src}
                WORKING_DIRECTORY ${SDIR}/src/driver/cpp/inserts
            )
            set(src ${src} ${BDIR}/inserts.driver.cpp.cpp ${gen_src})
            set_source_files_properties(${gen_src} PROPERTIES HEADER_FILE_ONLY TRUE)

        post_target: |
            macro(flex_bison lexer parser)
                set(bdir ${BDIR_PRIVATE}/fb)

                if (NOT WIN32)
                    set(flex flex)
                    set(bison bison)
                endif()

                get_filename_component(d ${parser} DIRECTORY)
                execute_process(COMMAND ${CMAKE_COMMAND} -E make_directory ${bdir}/${d})

                add_custom_command(OUTPUT
                        ${bdir}/${parser}.cpp
                        ${bdir}/${parser}.hpp
                    COMMAND ${bison} -o ${bdir}/${parser}.cpp --defines=${bdir}/${parser}.hpp ${SDIR}/${parser}
                    DEPENDS ${bison} ${SDIR}/${parser}
                    WORKING_DIRECTORY ${bdir}/${d}
                )
                target_include_directories(${this} PRIVATE ${bdir}/${d})

                get_filename_component(d ${lexer} DIRECTORY)
                execute_process(COMMAND ${CMAKE_COMMAND} -E make_directory ${bdir}/${d})

                add_custom_command(OUTPUT
                        ${bdir}/${lexer}.cpp
                        #${bdir}/${lexer}.h
                    #COMMAND ${flex} -o ${bdir}/${lexer}.cpp --header-file=${lexer}.h ${SDIR}/${lexer}
                    COMMAND ${flex} -o ${bdir}/${lexer}.cpp ${SDIR}/${lexer}
                    DEPENDS ${flex} ${SDIR}/${lexer} ${bdir}/${parser}.hpp
                    WORKING_DIRECTORY ${bdir}
                )
                target_include_directories(${this} PRIVATE ${bdir}/${d})

                target_sources(${this} PRIVATE
                    ${bdir}/${parser}.cpp
                    ${bdir}/${parser}.hpp
                    ${bdir}/${lexer}.cpp
                    #${bdir}/${lexer}.h
                )
            endmacro()

            flex_bison(src/driver/cpp/bazel/lexer.ll src/driver/cpp/bazel/grammar.yy)


    driver.cppan:
        type: library
        #static_only: true
        api_name: SW_DRIVER_CPP_API
        #export_if_static: true

        files:
            - include/sw/driver/cppan/.*
            - src/driver/cppan/.*

        include_directories:
            - include

        dependencies:
            - builder

    builder:
        type: library
        api_name: SW_BUILDER_API
        export_if_static: true

        files:
            - include/sw/builder/.*
            - src/builder/.*
        exclude_from_build:
            - src/builder/db_sqlite.*
            - src/builder/inserts/.*

        include_directories:
            - include
            - src/builder # make private

        options:
            any:
                compile_options:
                    msvc:
                        public:
                            - /wd4244 # conversion from to, possible loss of data
                            - /bigobj

        dependencies:
            public:
                - manager
                - pvt.cppan.demo.preshing.junction: master
            private:
                - name: pvt.egorpugin.primitives.embedder
                  version: master
                  ref: embedder

        post_sources: |
            file(GLOB_RECURSE x "${SDIR}/*")
            source_group(TREE ${SDIR} PREFIX "Source Files" FILES ${x})

    manager:
        type: library
        #static_only: true
        api_name:
            - SW_MANAGER_API
        #export_if_static: true

        files:
            - include/sw/manager/.*
            - src/manager/.*

        include_directories:
            - include
            - src/manager # make private

        options:
            any:
                definitions:
                    public:
                        - VERSION_MAJOR=0
                        - VERSION_MINOR=3
                        - VERSION_PATCH=0
                compile_options:
                    msvc:
                        public:
                            - /wd4250 # A inherits B via dominance
                            - /wd4251 # needs to have dll-interface to be used by clients of
                            #- /wd4275 # non dll-interface used as base for dll-interface

        dependencies:
            - support
            - name: tools.sqlite2cpp
              ref: sqlite2cpp
            - pvt.egorpugin.primitives.yaml: master
            - pvt.egorpugin.primitives.version: master
            - pvt.egorpugin.primitives.date_time: master
            - pvt.egorpugin.primitives.lock: master
            - pvt.egorpugin.primitives.pack: master
            - pvt.egorpugin.primitives.win32helpers: master
            - pvt.egorpugin.primitives.db.sqlite3: master
            - pvt.cppan.demo.rbock.sqlpp11_connector_sqlite3: 0
            - pvt.cppan.demo.boost.variant: 1
            - pvt.cppan.demo.apolukhin.stacktrace: master
            - name: pvt.egorpugin.primitives.embedder
              version: master
              ref: embedder

        post_sources: |
            file(GLOB_RECURSE x "${SDIR}/*")
            source_group(TREE ${SDIR} PREFIX "Source Files" FILES ${x})

            set(gen_src
                ${SDIR}/src/manager/inserts/inserts.cpp.in
                ${SDIR}/src/manager/inserts/packages_db_schema.sql
                ${SDIR}/src/manager/inserts/service_db_schema.sql
            )
            add_custom_command(OUTPUT ${BDIR}/inserts.manager.cpp
                COMMAND ${embedder} ${SDIR}/src/manager/inserts/inserts.cpp.in ${BDIR}/inserts.manager.cpp
                DEPENDS ${embedder} ${gen_src}
                WORKING_DIRECTORY ${SDIR}/src/manager/inserts
            )
            set(src ${src} ${BDIR}/inserts.manager.cpp ${gen_src})

            macro(gen_sql f out ns)
                get_filename_component(d ${f} DIRECTORY)
                add_custom_command(OUTPUT ${BDIR}/${out}
                    COMMAND ${sqlite2cpp} ${f} ${BDIR}/${out} ${ns}
                    DEPENDS ${sqlite2cpp} ${f}
                )
                set(src ${src} ${BDIR}/${out})
            endmacro()

            gen_sql(${SDIR}/src/manager/inserts/packages_db_schema.sql db_packages.h db::packages)
            gen_sql(${SDIR}/src/manager/inserts/service_db_schema.sql db_service.h db::service)

    support:
        type: library
        api_name:
            - SW_SUPPORT_API

        root_directory: src/support
        files: .*

        options:
            any:
                definitions:
                    public:
                        - UNICODE
                compile_options:
                    clang:
                        public:
                            - -Wno-assume
                            - -Wno-unused-command-line-argument
                            - -Wno-potentially-evaluated-expression
                            - -Wno-delete-non-virtual-dtor
                            - -Wno-unused-parameter
                            - -Wno-multiple-move-vbase
                            - -Wno-switch
                            - -Wno-return-type
                    gnu:
                        public:
                            - -w
                            - -fpermissive
                            #- -Wno-virtual-move-assign
                    msvc:
                        public:
                            #- /wd4101 # unreferenced local variable
                            - -D_SILENCE_ALL_CXX17_DEPRECATION_WARNINGS
            shared:
                link_options:
                    msvc:
                        public:
                            - -FORCE:MULTIPLE
                            - -ignore:4006

        dependencies:
            - pvt.egorpugin.primitives.filesystem: master
            - pvt.egorpugin.primitives.hash: master
            - pvt.egorpugin.primitives.http: master
            - pvt.egorpugin.primitives.templates: master
            - pvt.egorpugin.primitives.command: master
            - pvt.cppan.demo.boost.property_tree: 1
            - pvt.cppan.demo.nlohmann.json: "*"
            - pvt.egorpugin.primitives.log: master
            - pvt.egorpugin.primitives.executor: master
            - pvt.cppan.demo.boost.dll: 1
            - pvt.cppan.demo.boost.stacktrace: 1

        post_sources: |
            file(GLOB_RECURSE x "${SDIR}/*")
            source_group(TREE ${SDIR} PREFIX "Source Files" FILES ${x})

    test.unit.path:
        copy_to_output_dir: false
        api_name: SW_MANAGER_API
        files:
            - test/unit/path.cpp
            - src/manager/package_path.cpp
            - src/manager/package_path.h
        include_directories:
            - src/manager
        dependencies:
            - support
            - pvt.cppan.demo.catchorg.catch2: 2

    test.unit.api:
        copy_to_output_dir: false
        files: test/unit/api.cpp
        dependencies:
            - driver.cpp

    test.unit.sources:
        copy_to_output_dir: false
        files: test/unit/sources.cpp
        dependencies:
            - driver.cpp
            - pvt.cppan.demo.catchorg.catch2: 2

    test.unit.property:
        copy_to_output_dir: false
        files:
            - test/unit/property.cpp
            - src/manager/property.cpp
            - src/manager/property.h
        include_directories:
            - src/manager
        dependencies:
            - support
            - pvt.cppan.demo.catchorg.catch2: 2
